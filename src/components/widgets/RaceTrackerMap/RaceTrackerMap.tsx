import * as _ from 'lodash';
import * as React from "react";

import WebMercatorViewport from 'viewport-mercator-project';
import bbox from '@turf/bbox';
import * as turf from '@turf/turf'




import ReactMapGL, {
  NavigationControl,
  FlyToInterpolator,
  // LinearInterpolator
  Popup
} from "react-map-gl";
import {
  defaultMapStyle,
  pointLayer
} from "./MapStyle";
import {fromJS} from "immutable";
import {Img} from 'components/Img/Img';
import * as trackLeaderService from 'services/trackLeaders';
import {takeUntil} from 'rxjs/operators';
import {Subject} from 'rxjs';

import reCenter from 'assets/images/recenter.png';
import imgDaveMinusPin from 'assets/images/personPinMinus.png';
import imgPersonPin from 'assets/images/personPin.png';
import imgDavePlusPin from 'assets/images/personPinPlus.png';

import 'mapbox-gl/dist/mapbox-gl.css';
import styles from './RaceTrackerMap.module.css';



const TOKEN = "pk.eyJ1IjoicnNiYXVtYW5uIiwiYSI6ImNqd281d2M3bzF4MHczeXA5dm9xdXg4bjAifQ._vwACgp12mC4RBpuSYl1CA";

//More accurate route coordinate is in the file PolylineRoute. When using that the functions calling it becomes very 
//show
//For now i am using the simplified route provided by Ryan Baumann
const route = {
  "type": "Feature", "properties": {}, "geometry": {
    "type": "MultiLineString", "coordinates": [[
      [-117.38426, 33.19446], [-117.38734, 33.20166], [-117.37636, 33.21187], [-117.36224, 33.21465], [-117.35585, 33.22041], [-117.34333, 33.22376], [-117.33893, 33.23835], [-117.31, 33.23991], [-117.30233, 33.24309], [-117.29926, 33.25466], [-117.28607, 33.2553], [-117.26405, 33.26014], [-117.26467, 33.27234], [-117.27072, 33.27803], [-117.27072, 33.28663], [-117.26547, 33.29253], [-117.2666, 33.30163], [-117.24693, 33.30121], [-117.24313, 33.29359], [-117.22146, 33.28756], [-117.21355, 33.29011], [-117.20452, 33.28399], [-117.18767, 33.28185], [-117.18699, 33.27655], [-117.16897, 33.26717], [-117.15704, 33.2665], [-117.15344, 33.25058], [-117.09858, 33.25253], [-117.07594, 33.25722], [-117.05502, 33.24768], [-117.05529, 33.24093], [-117.04239, 33.2281], [-117.02107, 33.23132], [-117.01716, 33.22807], [-116.96689, 33.2288], [-116.96318, 33.24987], [-116.9537, 33.26611], [-116.95435, 33.28394], [-116.93886, 33.30201], [-116.9292, 33.30485], [-116.91302, 33.30223], [-116.90597, 33.29529], [-116.88408, 33.28679], [-116.87461, 33.28779], [-116.8626, 33.27557], [-116.84828, 33.27251], [-116.83361, 33.27508], [-116.82492, 33.26903], [-116.80475, 33.26213], [-116.77398, 33.24004], [-116.76026, 33.23444], [-116.75185, 33.22262], [-116.7216, 33.2031], [-116.71024, 33.19988], [-116.70971, 33.21462], [-116.69049, 33.23981], [-116.67483, 33.24881], [-116.66632, 33.24216], [-116.64235, 33.23231], [-116.62067, 33.22836], [-116.60609, 33.22137], [-116.59136, 33.21718], [-116.57708, 33.21869], [-116.56384, 33.21243], [-116.54149, 33.21024], [-116.47944, 33.20999], [-116.46496, 33.21505], [-116.44583, 33.21124], [-116.43005, 33.21084], [-116.41079, 33.22946], [-116.41041, 33.23529], [-116.40157, 33.24472], [-116.4052, 33.25073], [-116.39925, 33.25639], [-116.376, 33.25647], [-116.37425, 33.23824], [-116.37535, 33.22519], [-116.36404, 33.21149], [-116.32969, 33.21108], [-116.24736, 33.15964], [-116.22411, 33.15947], [-116.20327, 33.15719], [-116.17716, 33.15214], [-116.14949, 33.14903], [-116.12933, 33.14319], [-116.10415, 33.1397], [-116.05583, 33.12564], [-115.85552, 33.12572], [-115.843, 33.11184], [-115.82764, 33.10669], [-115.80268, 33.10382], [-115.75051, 33.08059], [-115.74103, 33.07415], [-115.71246, 33.04099], [-115.70292, 33.03748], [-115.6166, 33.03723], [-115.61235, 33.03449], [-115.59658, 33.00909], [-115.5786, 32.98509], [-115.57105, 32.97989], [-115.55344, 32.97845], [-115.46415, 32.97861], [-115.45656, 32.97452], [-115.30156, 32.97471], [-115.28246, 32.9705], [-115.21279, 32.97041], [-115.19025, 32.96932], [-115.16849, 32.97792], [-115.14859, 32.98099], [-115.10904, 32.99343], [-115.0733, 32.9958], [-115.0473, 33.01249], [-115.03815, 33.01495], [-114.99764, 33.015], [-114.99183, 33.01616], [-114.96483, 33.03037], [-114.95059, 33.0514], [-114.94935, 33.06887], [-114.93893, 33.07929], [-114.90921, 33.08632], [-114.9033, 33.09158], [-114.89942, 33.10382], [-114.89246, 33.11097], [-114.87513, 33.14071], [-114.86886, 33.15616], [-114.86854, 33.16914], [-114.8572, 33.2018], [-114.8537, 33.21816], [-114.84601, 33.23057], [-114.82839, 33.24418], [-114.81708, 33.24999], [-114.79915, 33.26743], [-114.78175, 33.28108], [-114.75849, 33.28929], [-114.75194, 33.2939], [-114.73397, 33.31612], [-114.72392, 33.33513], [-114.72182, 33.3638], [-114.72166, 33.39225], [-114.73119, 33.40839], [-114.73264, 33.43813], [-114.73068, 33.45287], [-114.73093, 33.47784], [-114.70884, 33.47777], [-114.70857, 33.50706], [-114.65613, 33.50695], [-114.65758, 33.61009], [-114.57072, 33.61089], [-114.57283, 33.69946], [-114.54793, 33.71153], [-114.53287, 33.71246], [-114.51699, 33.72553], [-114.51522, 33.73655], [-114.51686, 33.75513], [-114.52309, 33.78412], [-114.53604, 33.82914], [-114.53301, 33.85699], [-114.5248, 33.87891], [-114.52603, 33.89066], [-114.53285, 33.90644], [-114.53384, 33.92043], [-114.54106, 33.93095], [-114.53903, 33.94281], [-114.5324, 33.95297], [-114.51863, 33.96632], [-114.51324, 33.97468], [-114.49717, 33.98584], [-114.48412, 34.00325], [-114.48675, 34.02913], [-114.48116, 34.04333], [-114.43724, 34.04251], [-114.39005, 34.04265], [-114.39002, 34.08967], [-114.38149, 34.10055], [-114.36304, 34.10824], [-114.32358, 34.12797], [-114.31166, 34.12962], [-114.3067, 34.14639], [-114.28913, 34.15024], [-114.28, 34.13264], [-114.27703, 34.09621], [-114.27463, 34.0899], [-114.25977, 34.07045], [-114.25754, 34.06265], [-114.25859, 34.03445], [-114.24243, 34.00836], [-114.22805, 33.99841], [-114.20921, 33.99296], [-114.18521, 33.9959], [-114.14362, 33.99469], [-114.12904, 33.99314], [-114.09744, 33.99394], [-114.07887, 33.99058], [-114.04709, 33.9747], [-114.01622, 33.94594], [-113.99002, 33.91259], [-113.79465, 33.77191], [-113.77337, 33.75313], [-113.74582, 33.74231], [-113.70341, 33.72381], [-113.69074, 33.72436], [-113.6808, 33.73014], [-113.67205, 33.74913], [-113.65404, 33.75986], [-113.53829, 33.82415], [-113.52603, 33.82408], [-113.32875, 33.89249], [-113.19653, 33.938], [-113.1753, 33.94285], [-113.14349, 33.94294], [-113.14155, 33.94836], [-113.13983, 33.98006], [-113.13084, 33.99269], [-113.00416, 34.09348], [-112.98918, 34.108], [-112.85351, 34.16188], [-112.83459, 34.16862], [-112.8304, 34.17775], [-112.8004, 34.20756], [-112.78058, 34.20064], [-112.77229, 34.2033], [-112.76154, 34.19991], [-112.75355, 34.20794], [-112.75051, 34.21749], [-112.73913, 34.23145], [-112.73452, 34.25295], [-112.72722, 34.26457], [-112.72716, 34.27457], [-112.72264, 34.28047], [-112.72308, 34.29622], [-112.69463, 34.32832], [-112.68776, 34.33021], [-112.68215, 34.34948], [-112.66592, 34.37065], [-112.67994, 34.38641], [-112.70445, 34.4016], [-112.71003, 34.4172], [-112.70088, 34.42108], [-112.69309, 34.43137], [-112.69492, 34.44065], [-112.69271, 34.46269], [-112.68831, 34.47534], [-112.68639, 34.49565], [-112.68354, 34.50245], [-112.6917, 34.50904], [-112.6916, 34.51848], [-112.66741, 34.56391], [-112.63295, 34.58203], [-112.62177, 34.60131], [-112.61032, 34.59844], [-112.59316, 34.59795], [-112.5788, 34.58826], [-112.5188, 34.5773], [-112.50852, 34.57041], [-112.49665, 34.56921], [-112.4877, 34.56303], [-112.48226, 34.56812], [-112.48142, 34.58271], [-112.44729, 34.61171], [-112.43935, 34.62855], [-112.41205, 34.6364], [-112.39993, 34.63641], [-112.38349, 34.63065], [-112.36314, 34.63027], [-112.30111, 34.6432], [-112.28722, 34.652], [-112.26948, 34.65503], [-112.24846, 34.66377], [-112.21573, 34.66748], [-112.19312, 34.67847], [-112.17539, 34.67827], [-112.17072, 34.68201], [-112.16687, 34.69511], [-112.15529, 34.70046], [-112.14948, 34.70801], [-112.15654, 34.72073], [-112.14813, 34.72223], [-112.12878, 34.73847], [-112.10372, 34.74809], [-112.08745, 34.75781], [-112.06194, 34.76097], [-112.03185, 34.73454], [-112.02162, 34.72903], [-112.00954, 34.72854], [-111.99005, 34.70328], [-111.97332, 34.67803], [-111.96823, 34.66494], [-111.95249, 34.64614], [-111.93011, 34.62544], [-111.92099, 34.61973], [-111.90739, 34.60379], [-111.89262, 34.59544], [-111.873, 34.55586], [-111.85781, 34.55796], [-111.84959, 34.54921], [-111.83204, 34.54726], [-111.80605, 34.52803], [-111.78771, 34.53037], [-111.77807, 34.52595], [-111.77251, 34.51095], [-111.7585, 34.50617], [-111.74783, 34.51247], [-111.72463, 34.50389], [-111.71463, 34.49465], [-111.69491, 34.48999], [-111.68302, 34.49565], [-111.6701, 34.50538], [-111.64519, 34.50517], [-111.62129, 34.48615], [-111.5974, 34.4891], [-111.57699, 34.50319], [-111.55927, 34.50878], [-111.54364, 34.51108], [-111.52029, 34.51983], [-111.50959, 34.5213], [-111.50455, 34.51697], [-111.48407, 34.51311], [-111.46237, 34.50031], [-111.44769, 34.46775], [-111.43862, 34.45411], [-111.41846, 34.45065], [-111.411, 34.45638], [-111.39727, 34.45521], [-111.38325, 34.4656], [-111.38126, 34.48248], [-111.37041, 34.49185], [-111.36076, 34.50749], [-111.34226, 34.50823], [-111.34174, 34.52831], [-111.33889, 34.53491], [-111.31519, 34.54938], [-111.32023, 34.56857], [-111.33366, 34.58214], [-111.34136, 34.60898], [-111.34247, 34.6234], [-111.35056, 34.63306], [-111.36025, 34.63642], [-111.37195, 34.64901], [-111.37951, 34.6685], [-111.38237, 34.69786], [-111.38994, 34.71953], [-111.39798, 34.72707], [-111.40505, 34.73949], [-111.42375, 34.7477], [-111.4343, 34.76328], [-111.43523, 34.77364], [-111.44372, 34.79069], [-111.43772, 34.79997], [-111.43459, 34.81731], [-111.43834, 34.83488], [-111.43658, 34.86545], [-111.43993, 34.8869], [-111.43868, 34.9014], [-111.43209, 34.90705], [-111.43042, 34.9319], [-111.43732, 34.96444], [-111.44739, 34.97922], [-111.45391, 34.99726], [-111.45106, 35.0203], [-111.45648, 35.0488], [-111.46112, 35.05597], [-111.49147, 35.06544], [-111.50724, 35.06553], [-111.52078, 35.07115], [-111.54231, 35.0943], [-111.56763, 35.10636], [-111.59365, 35.11685], [-111.60551, 35.12888], [-111.61413, 35.13294], [-111.63942, 35.13635], [-111.64787, 35.14147], [-111.65703, 35.15382], [-111.64773, 35.16182], [-111.64826, 35.18384], [-111.64439, 35.19241], [-111.63169, 35.1911], [-111.61989, 35.19502], [-111.61096, 35.20744], [-111.59532, 35.21573], [-111.58068, 35.22639], [-111.57185, 35.2386], [-111.5495, 35.26121], [-111.54208, 35.2834], [-111.54267, 35.32265], [-111.54945, 35.3343], [-111.56885, 35.3531], [-111.57236, 35.36711], [-111.58031, 35.38295], [-111.55804, 35.46896], [-111.55404, 35.49348], [-111.54441, 35.51489], [-111.53073, 35.57478], [-111.51618, 35.64966], [-111.50467, 35.68973], [-111.48479, 35.7212], [-111.4672, 35.75952], [-111.46099, 35.77558], [-111.44903, 35.79223], [-111.4358, 35.83952], [-111.43113, 35.84793], [-111.41386, 35.86936], [-111.40577, 35.89749], [-111.39303, 35.99111], [-111.39791, 36.03591], [-111.39207, 36.07417], [-111.37067, 36.08147], [-111.36684, 36.09006], [-111.35867, 36.09597], [-111.3384, 36.09896], [-111.2952, 36.10191], [-111.24578, 36.10778], [-111.23409, 36.11189], [-111.22468, 36.12118], [-111.20154, 36.12521], [-111.18975, 36.13026], [-111.09561, 36.16447], [-111.07605, 36.18075], [-111.02685, 36.23634], [-111.0146, 36.27127], [-110.99076, 36.29127], [-110.95087, 36.31745], [-110.92595, 36.32893], [-110.88098, 36.39011], [-110.87812, 36.39214], [-110.79143, 36.42405], [-110.75173, 36.43969], [-110.73866, 36.44149], [-110.65493, 36.47673], [-110.6327, 36.49048], [-110.59323, 36.51699], [-110.54352, 36.54329], [-110.4821, 36.56999], [-110.47169, 36.58444], [-110.47299, 36.60708], [-110.46359, 36.62093], [-110.43823, 36.64084], [-110.41784, 36.66201], [-110.39069, 36.67824], [-110.36201, 36.6937], [-110.3344, 36.69847], [-110.3012, 36.69947], [-110.2481, 36.70751], [-110.25632, 36.72218], [-110.23078, 36.74314], [-110.22586, 36.75166], [-110.2344, 36.81789], [-110.24673, 36.83303], [-110.26488, 36.84094], [-110.26984, 36.85573], [-110.22281, 36.92829], [-110.18207, 36.98244], [-110.17011, 37.00999], [-110.1425, 37.02145], [-110.12847, 37.02538], [-110.09748, 37.04301], [-110.08472, 37.05733], [-110.05983, 37.06769], [-110.03598, 37.06922], [-110.02048, 37.08158], [-109.9866, 37.10421], [-109.95693, 37.11693], [-109.93761, 37.12109], [-109.91815, 37.12795], [-109.89311, 37.13044], [-109.88068, 37.13781], [-109.86737, 37.15113], [-109.85739, 37.15016], [-109.86064, 37.16786], [-109.85941, 37.17949], [-109.86536, 37.19527], [-109.86139, 37.20145], [-109.84546, 37.21264], [-109.82499, 37.21986], [-109.8142, 37.23485], [-109.77111, 37.24558], [-109.73229, 37.26182], [-109.69803, 37.2837], [-109.69087, 37.28355], [-109.67992, 37.27562], [-109.67407, 37.26074], [-109.65451, 37.26375], [-109.60977, 37.26699], [-109.57634, 37.27998], [-109.52027, 37.28561], [-109.50809, 37.28207], [-109.49444, 37.28465], [-109.47944, 37.29658], [-109.45514, 37.3006], [-109.43066, 37.29889], [-109.42074, 37.29271], [-109.39923, 37.28973], [-109.35908, 37.27454], [-109.33233, 37.27361], [-109.30608, 37.26149], [-109.2915, 37.25746], [-109.26819, 37.25866], [-109.25982, 37.25458], [-109.25395, 37.24607], [-109.23799, 37.23896], [-109.22778, 37.23719], [-109.19775, 37.22009], [-109.18682, 37.21968], [-109.17966, 37.22399], [-109.15371, 37.25003], [-109.15478, 37.25671], [-109.14967, 37.27222], [-109.13798, 37.28961], [-109.12479, 37.29875], [-109.11212, 37.29989], [-109.0833, 37.2975], [-109.06625, 37.31295], [-109.05804, 37.3152], [-109.04777, 37.32866], [-109.03198, 37.3257], [-109.01652, 37.32771], [-109.00006, 37.33277], [-108.97012, 37.33164], [-108.9492, 37.33361], [-108.92253, 37.32327], [-108.90569, 37.32225], [-108.89146, 37.32773], [-108.85315, 37.3332], [-108.81869, 37.3411], [-108.76466, 37.32794], [-108.74393, 37.33411], [-108.72726, 37.33237], [-108.70844, 37.32352], [-108.68257, 37.32282], [-108.65865, 37.31164], [-108.61065, 37.31235], [-108.60636, 37.33022], [-108.59103, 37.34846], [-108.55915, 37.34889], [-108.54845, 37.35373], [-108.52375, 37.34863], [-108.48284, 37.34776], [-108.43077, 37.35314], [-108.41674, 37.34688], [-108.41215, 37.34114], [-108.38667, 37.33319], [-108.36257, 37.32259], [-108.35334, 37.3241], [-108.31228, 37.34609], [-108.27672, 37.34761], [-108.26801, 37.34923], [-108.24945, 37.35897], [-108.23482, 37.35833], [-108.21725, 37.35095], [-108.21287, 37.34642], [-108.21341, 37.33569], [-108.19004, 37.33914], [-108.1716, 37.325], [-108.16322, 37.3223], [-108.11725, 37.32805], [-108.1009, 37.32695], [-108.08986, 37.32075], [-108.07151, 37.3153], [-108.04865, 37.29523], [-108.02486, 37.28347], [-108.00795, 37.272], [-107.9909, 37.26387], [-107.97233, 37.26397], [-107.96185, 37.26715], [-107.95821, 37.27822], [-107.93607, 37.27875], [-107.92208, 37.26623], [-107.90857, 37.26984], [-107.89156, 37.27082], [-107.88095, 37.26589], [-107.87033, 37.23736], [-107.85501, 37.22109], [-107.83283, 37.22878], [-107.81081, 37.22726], [-107.79643, 37.22955], [-107.76635, 37.22968], [-107.72607, 37.22817], [-107.70173, 37.2252], [-107.68582, 37.22678], [-107.67861, 37.2237], [-107.65874, 37.22534], [-107.64241, 37.21779], [-107.62403, 37.222], [-107.61407, 37.22872], [-107.58704, 37.23441], [-107.57529, 37.24076], [-107.57111, 37.25289], [-107.5593, 37.27027], [-107.5379, 37.28505], [-107.50665, 37.28912], [-107.49962, 37.28472], [-107.48014, 37.28618], [-107.45937, 37.27395], [-107.44673, 37.26023], [-107.43565, 37.24224], [-107.41255, 37.22833], [-107.39468, 37.23193], [-107.37934, 37.22867], [-107.34808, 37.22836], [-107.34016, 37.22234], [-107.33929, 37.21293], [-107.33145, 37.20417], [-107.30798, 37.20694], [-107.2927, 37.21316], [-107.27343, 37.21305], [-107.24738, 37.20764], [-107.23019, 37.2134], [-107.2156, 37.22506], [-107.19394, 37.22887], [-107.1749, 37.23648], [-107.14912, 37.24078], [-107.13096, 37.23813], [-107.11765, 37.2273], [-107.10871, 37.2292], [-107.09443, 37.24498], [-107.05502, 37.26672], [-107.03619, 37.27313], [-107.02865, 37.26786], [-107.01138, 37.2663], [-106.99441, 37.2694], [-106.98391, 37.27774], [-106.97471, 37.29104], [-106.9621, 37.32265], [-106.9511, 37.33359], [-106.92055, 37.34842], [-106.90184, 37.36758], [-106.89942, 37.37607], [-106.89592, 37.41598], [-106.88762, 37.43396], [-106.87755, 37.44259], [-106.88508, 37.46105], [-106.86683, 37.47545], [-106.84216, 37.48469], [-106.81803, 37.48837], [-106.79534, 37.48137], [-106.79148, 37.47438], [-106.7748, 37.47913], [-106.76584, 37.49078], [-106.77393, 37.50555], [-106.76952, 37.52498], [-106.77211, 37.54361], [-106.77659, 37.55343], [-106.76661, 37.56522], [-106.73108, 37.58974], [-106.7256, 37.60419], [-106.7207, 37.60801], [-106.69386, 37.61542], [-106.66226, 37.64398], [-106.64783, 37.66267], [-106.63949, 37.66937], [-106.60101, 37.6772], [-106.57021, 37.6762], [-106.54889, 37.67918], [-106.52304, 37.68057], [-106.49297, 37.67709], [-106.43428, 37.67668], [-106.40659, 37.67315], [-106.36823, 37.67936], [-106.34136, 37.67783], [-106.32876, 37.6749], [-106.27555, 37.64987], [-106.24804, 37.62631], [-106.19044, 37.58197], [-106.1455, 37.58044], [-106.13098, 37.57516], [-105.98459, 37.51346], [-105.87634, 37.46727], [-105.86244, 37.46707], [-105.85645, 37.47303], [-105.71145, 37.47452], [-105.58975, 37.47492], [-105.57812, 37.47146], [-105.52107, 37.43712], [-105.51698, 37.43569], [-105.431, 37.42723], [-105.41298, 37.42779], [-105.39735, 37.43151], [-105.38796, 37.43677], [-105.3572, 37.46178], [-105.33986, 37.49174], [-105.31229, 37.51365], [-105.30123, 37.51748], [-105.29688, 37.52879], [-105.28476, 37.54597], [-105.28672, 37.56203], [-105.27093, 37.57844], [-105.26047, 37.58592], [-105.24763, 37.59027], [-105.22757, 37.6053], [-105.19279, 37.61698], [-105.18264, 37.60798], [-105.18481, 37.59358], [-105.168, 37.57338], [-105.12467, 37.55478], [-105.11036, 37.55312], [-105.06995, 37.54154], [-105.05972, 37.54141], [-105.0412, 37.52157], [-105.01711, 37.51399], [-105.01136, 37.50895], [-105.01145, 37.50036], [-105.02051, 37.49869], [-105.0209, 37.48153], [-105.03654, 37.44941], [-105.03718, 37.43697], [-105.05765, 37.41525], [-105.0689, 37.41256], [-105.0813, 37.40122], [-105.10453, 37.3756], [-105.10619, 37.35266], [-105.09756, 37.34446], [-105.09624, 37.33326], [-105.07859, 37.32104], [-105.05986, 37.31111], [-105.03713, 37.2528], [-105.04253, 37.2483], [-105.04903, 37.23151], [-105.05065, 37.20015], [-105.04357, 37.19004], [-105.0483, 37.18496], [-105.04004, 37.15092], [-105.02606, 37.14891], [-105.01818, 37.15241], [-104.98247, 37.15577], [-104.95122, 37.16172], [-104.93076, 37.15798], [-104.88283, 37.1419], [-104.87208, 37.13464], [-104.84369, 37.12879], [-104.83336, 37.12965], [-104.82541, 37.13544], [-104.79431, 37.12891], [-104.78606, 37.12428], [-104.76932, 37.12149], [-104.75866, 37.12513], [-104.73165, 37.12282], [-104.71118, 37.12451], [-104.69495, 37.12887], [-104.6656, 37.12712], [-104.65728, 37.12285], [-104.64523, 37.1251], [-104.63854, 37.13021], [-104.62616, 37.13098], [-104.61078, 37.15372], [-104.59845, 37.16144], [-104.58279, 37.15814], [-104.57277, 37.15065], [-104.55908, 37.15014], [-104.54266, 37.15465], [-104.52751, 37.16522], [-104.50783, 37.16745], [-104.48663, 37.17856], [-104.46088, 37.2104], [-104.44829, 37.21635], [-104.41801, 37.22421], [-104.41096, 37.22861], [-104.39881, 37.22566], [-104.32873, 37.2346], [-104.3061, 37.23277], [-104.24654, 37.20776], [-104.21663, 37.20354], [-104.20742, 37.19763], [-104.15265, 37.18903], [-104.04314, 37.12581], [-104.03232, 37.12495], [-103.99106, 37.13488], [-103.98453, 37.13785], [-103.94954, 37.16151], [-103.89524, 37.17161], [-103.78169, 37.16001], [-103.76046, 37.16763], [-103.74264, 37.16904], [-103.72851, 37.17592], [-103.61721, 37.21849], [-103.6132, 37.21926], [-103.52053, 37.21827], [-103.4304, 37.22007], [-103.35711, 37.22058], [-103.3549, 37.22216], [-103.35578, 37.27459], [-103.35113, 37.27882], [-103.19237, 37.27938], [-103.17145, 37.27901], [-102.907, 37.27931], [-102.90475, 37.28096], [-102.90478, 37.36431], [-102.90232, 37.36636], [-102.85992, 37.36752], [-102.85772, 37.38206], [-102.7783, 37.3823], [-102.61513, 37.38344], [-102.48467, 37.38366], [-102.4523, 37.3797], [-102.43168, 37.3802], [-102.33148, 37.38044], [-102.30333, 37.38111], [-102.15558, 37.43109], [-102.10302, 37.44551], [-102.08351, 37.45531], [-102.04089, 37.47046], [-101.85736, 37.53156], [-101.76184, 37.56377], [-101.76164, 37.57744], [-101.69159, 37.57707], [-101.48841, 37.57661], [-101.35309, 37.57645], [-101.29947, 37.56174], [-101.14498, 37.56189], [-100.87102, 37.5622], [-100.68878, 37.56208], [-100.56526, 37.56222], [-100.51749, 37.57826], [-100.333, 37.63019], [-100.30464, 37.63733], [-100.24259, 37.65], [-99.97923, 37.64853], [-99.78909, 37.6455], [-99.75404, 37.64609], [-99.75066, 37.63314], [-99.71662, 37.61236], [-99.68726, 37.58955], [-99.67748, 37.58629], [-99.52429, 37.58602], [-99.39971, 37.5864], [-99.37708, 37.59802], [-99.32601, 37.606], [-99.2807, 37.60622], [-99.2717, 37.6085], [-99.21284, 37.60838], [-99.12372, 37.61334], [-99.10778, 37.613], [-99.08623, 37.61589], [-99.00415, 37.62105], [-98.82943, 37.64133], [-98.79363, 37.64246], [-98.76733, 37.64186], [-98.74695, 37.64598], [-98.70245, 37.6454], [-98.60226, 37.64602], [-98.47123, 37.64544], [-98.45341, 37.64422], [-98.42652, 37.63754], [-98.40505, 37.64424], [-98.36148, 37.64515], [-98.24606, 37.64502], [-98.13587, 37.64717], [-98.09903, 37.64691], [-98.06619, 37.66508], [-98.04398, 37.66781], [-98.04508, 37.71894], [-97.91819, 37.71937], [-97.82956, 37.71896], [-97.81578, 37.71656], [-97.80746, 37.71912], [-97.68004, 37.72112], [-97.53543, 37.7216], [-97.53588, 37.77907], [-97.45632, 37.78095], [-97.38947, 37.78154], [-97.31733, 37.78137], [-97.31517, 37.79586], [-97.12355, 37.79584], [-97.09061, 37.79771], [-97.06624, 37.79588], [-96.89871, 37.79552], [-96.89869, 37.81665], [-96.84348, 37.81727], [-96.81062, 37.80996], [-96.66566, 37.81051], [-96.55101, 37.81018], [-96.49378, 37.81233], [-96.46947, 37.81465], [-96.44986, 37.81015], [-96.33185, 37.81006], [-96.30605, 37.8146], [-96.29794, 37.81777], [-96.23228, 37.81747], [-96.22674, 37.81848], [-96.18617, 37.83746], [-96.17223, 37.83892], [-96.1171, 37.83774], [-96.10303, 37.83909], [-96.07555, 37.83714], [-95.955, 37.83629], [-95.85513, 37.83614], [-95.8475, 37.83816], [-95.80849, 37.86539], [-95.76504, 37.87953], [-95.66835, 37.87866], [-95.66073, 37.88166], [-95.64094, 37.90068], [-95.54308, 37.91941], [-95.49934, 37.922], [-95.30036, 37.92201], [-95.16453, 37.92153], [-95.1474, 37.9145], [-95.10014, 37.90747], [-95.05991, 37.89227], [-95.03777, 37.89115], [-95.01469, 37.88325], [-94.99734, 37.86813], [-94.985, 37.86355], [-94.89602, 37.86301], [-94.74955, 37.86333], [-94.71098, 37.85466], [-94.70726, 37.84183], [-94.67948, 37.84189], [-94.66896, 37.84501], [-94.63753, 37.84477], [-94.62027, 37.84152], [-94.59153, 37.84359], [-94.40466, 37.83781], [-94.34247, 37.83667], [-94.33802, 37.84568], [-94.3197, 37.85117], [-94.29379, 37.86397], [-94.17393, 37.86003], [-94.15738, 37.86063], [-94.13537, 37.8554], [-94.11026, 37.85367], [-94.09135, 37.86301], [-94.07607, 37.86477], [-93.94204, 37.8603], [-93.92006, 37.86649], [-93.90109, 37.86734], [-93.86112, 37.87928], [-93.8476, 37.88039], [-93.83155, 37.88934], [-93.80463, 37.89389], [-93.77446, 37.89716], [-93.76144, 37.89458], [-93.71498, 37.90418], [-93.68378, 37.90327], [-93.67466, 37.89218], [-93.55803, 37.88966], [-93.53433, 37.89055], [-93.50575, 37.89726], [-93.49853, 37.91088], [-93.48482, 37.91823], [-93.47576, 37.92763], [-93.47501, 37.9425], [-93.46695, 37.94827], [-93.38785, 37.94599], [-93.3647, 37.94875], [-93.34496, 37.94552], [-93.33186, 37.94816], [-93.31604, 37.94237], [-93.30507, 37.94782], [-93.28219, 37.93545], [-93.26812, 37.93506], [-93.24265, 37.94162], [-93.12328, 37.93983], [-93.10898, 37.93702], [-93.08245, 37.93834], [-93.0587, 37.93153], [-93.01076, 37.92919], [-93.00487, 37.93018], [-92.98482, 37.94523], [-92.97043, 37.96577], [-92.90418, 37.97048], [-92.87993, 37.98422], [-92.8529, 37.99001], [-92.80386, 37.9916], [-92.78692, 37.99773], [-92.76707, 37.99669], [-92.7463, 38.00642], [-92.73955, 38.01313], [-92.7211, 38.02439], [-92.70205, 38.04244], [-92.69926, 38.05884], [-92.6907, 38.07264], [-92.69037, 38.08788], [-92.68672, 38.1001], [-92.6911, 38.1128], [-92.68268, 38.12491], [-92.63915, 38.13436], [-92.61528, 38.1482], [-92.60803, 38.1697], [-92.60898, 38.17791], [-92.60632, 38.20253], [-92.60962, 38.20883], [-92.6245, 38.21782], [-92.62523, 38.22425], [-92.61787, 38.23966], [-92.59741, 38.24498], [-92.58184, 38.26452], [-92.5803, 38.29174], [-92.57631, 38.31822], [-92.56158, 38.33867], [-92.55215, 38.34837], [-92.54315, 38.36382], [-92.53011, 38.36892], [-92.48326, 38.36711], [-92.46004, 38.36985], [-92.44831, 38.37411], [-92.4252, 38.37304], [-92.40381, 38.37618], [-92.38384, 38.38908], [-92.37491, 38.39198], [-92.33836, 38.42076], [-92.31191, 38.43407], [-92.30294, 38.44211], [-92.30132, 38.45093], [-92.29239, 38.46643], [-92.27361, 38.47859], [-92.26684, 38.50077], [-92.24542, 38.50982], [-92.21017, 38.53806], [-92.2056, 38.54726], [-92.17132, 38.5779], [-92.18017, 38.58541], [-92.1678, 38.59862], [-92.14171, 38.59564], [-92.11486, 38.58391], [-92.09974, 38.58064], [-92.05813, 38.58277], [-92.02987, 38.58777], [-91.99555, 38.60228], [-91.98713, 38.60751], [-91.95461, 38.62194], [-91.94063, 38.62991], [-91.93865, 38.6346], [-91.91371, 38.6518], [-91.89046, 38.66531], [-91.87684, 38.66866], [-91.85056, 38.68723], [-91.8289, 38.69704], [-91.79375, 38.70705], [-91.77515, 38.7048], [-91.75544, 38.7085], [-91.7465, 38.70705], [-91.73681, 38.71258], [-91.71596, 38.71114], [-91.70441, 38.72474], [-91.68825, 38.7176], [-91.67366, 38.72046], [-91.66472, 38.71768], [-91.64369, 38.71935], [-91.62407, 38.70527], [-91.588, 38.7021], [-91.56336, 38.70353], [-91.54194, 38.70906], [-91.52851, 38.71518], [-91.50559, 38.72132], [-91.47015, 38.72801], [-91.44618, 38.72861], [-91.43814, 38.70781], [-91.41697, 38.70577], [-91.40081, 38.69454], [-91.3908, 38.69079], [-91.38729, 38.68422], [-91.36929, 38.66663], [-91.36053, 38.65221], [-91.34338, 38.64801], [-91.33649, 38.63773], [-91.30903, 38.63109], [-91.30265, 38.62249], [-91.28272, 38.6089], [-91.2638, 38.60417], [-91.25493, 38.59933], [-91.21645, 38.60086], [-91.19492, 38.5979], [-91.17298, 38.58962], [-91.14895, 38.5879], [-91.12523, 38.59015], [-91.09547, 38.57671], [-91.08073, 38.57508], [-91.07417, 38.56835], [-91.06145, 38.56433], [-91.03972, 38.55305], [-91.02913, 38.54541], [-91.01032, 38.5388], [-90.99492, 38.56371], [-91.00213, 38.59761], [-90.99568, 38.60512], [-90.98385, 38.61148], [-90.97998, 38.62593], [-90.97319, 38.6286], [-90.96373, 38.64171], [-90.94883, 38.66924], [-90.95079, 38.68433], [-90.93349, 38.68534], [-90.91851, 38.69934], [-90.9077, 38.7001], [-90.90224, 38.70552], [-90.87803, 38.71043], [-90.88165, 38.72108], [-90.87947, 38.73791], [-90.86837, 38.7558], [-90.86829, 38.76515], [-90.86087, 38.77515], [-90.85787, 38.78572], [-90.85143, 38.79072], [-90.85544, 38.80347], [-90.85268, 38.81055], [-90.83593, 38.81255], [-90.80993, 38.80948], [-90.7838, 38.80468], [-90.73834, 38.80654], [-90.72648, 38.80313], [-90.63657, 38.80353], [-90.61901, 38.81409], [-90.61472, 38.82325], [-90.62195, 38.82924], [-90.61868, 38.86128], [-90.60338, 38.86132], [-90.60056, 38.85402], [-90.5713, 38.85271], [-90.49293, 38.85322], [-90.49149, 38.84874], [-90.47003, 38.83327], [-90.45586, 38.8478], [-90.41738, 38.86595], [-90.40202, 38.86682], [-90.39785, 38.87455], [-90.37263, 38.87405], [-90.36388, 38.88646], [-90.35706, 38.90133], [-90.34915, 38.9092], [-90.32441, 38.90893], [-90.28655, 38.9058], [-90.26582, 38.90225], [-90.26368, 38.89254], [-90.22429, 38.88835], [-90.22705, 38.86674], [-90.21942, 38.86547], [-90.19035, 38.87628], [-90.1724, 38.88765], [-90.16046, 38.88796], [-90.14964, 38.89712], [-90.14927, 38.90323], [-90.13189, 38.90438], [-90.10999, 38.91013], [-90.08774, 38.90815], [-90.05813, 38.90061], [-90.04226, 38.9012], [-90.00736, 38.89859], [-89.99261, 38.8958], [-89.94463, 38.8983], [-89.92677, 38.89482], [-89.90527, 38.89456], [-89.89494, 38.88949], [-89.70833, 38.88817], [-89.60351, 38.88908], [-89.49982, 38.88684], [-89.48605, 38.89392], [-89.46046, 38.89371], [-89.45001, 38.8976], [-89.42041, 38.89782], [-89.41321, 38.88704], [-89.39328, 38.88721], [-89.38993, 38.879], [-89.28976, 38.91669], [-89.26324, 38.91878], [-89.256, 38.92112], [-89.2325, 38.93506], [-89.14108, 38.96721], [-89.13567, 38.97179], [-89.12618, 38.96428], [-89.09358, 38.96393], [-89.09313, 38.96062], [-89.04989, 38.96294], [-89.01709, 38.9723], [-89.00835, 38.97094], [-88.99939, 38.97732], [-88.82962, 39.02971], [-88.70705, 39.06745], [-88.60325, 39.09983], [-88.58136, 39.10902], [-88.55646, 39.11476], [-88.55506, 39.12028], [-88.5378, 39.11971], [-88.53249, 39.10926], [-88.51056, 39.10464], [-88.46221, 39.10382], [-88.42439, 39.07839], [-88.38441, 39.06217], [-88.37073, 39.06154], [-88.36145, 39.05598], [-88.30113, 39.04027], [-88.20421, 38.99165], [-88.14814, 38.991], [-88.14105, 39.00846], [-88.12477, 39.01086], [-87.96971, 39.00992], [-87.94246, 39.01021], [-87.92605, 39.00165], [-87.89444, 39.00181], [-87.87664, 39.00443], [-87.86456, 39.00261], [-87.81379, 39.00377], [-87.7934, 39.00521], [-87.71502, 39.00603], [-87.68471, 39.00818], [-87.68443, 39.10517], [-87.66412, 39.10686], [-87.64427, 39.11376], [-87.63244, 39.11505], [-87.62337, 39.12138], [-87.59689, 39.1211], [-87.57977, 39.11587], [-87.564, 39.11755], [-87.49788, 39.11744], [-87.49051, 39.10866], [-87.46682, 39.10283], [-87.42604, 39.10287], [-87.42375, 39.08831], [-87.41283, 39.07415], [-87.40877, 39.07605], [-87.28449, 39.07492], [-87.26891, 39.06957], [-87.24622, 39.06714], [-87.19116, 39.06701], [-87.18546, 39.0635], [-87.18156, 39.0361], [-87.16192, 39.03498], [-87.13998, 39.03865], [-87.06575, 39.03809], [-87.05718, 39.03493], [-87.02239, 39.03455], [-86.99804, 39.0292], [-86.96038, 39.02699], [-86.91253, 39.02742], [-86.88998, 39.02961], [-86.86739, 39.03766], [-86.81902, 39.04212], [-86.7997, 39.04792], [-86.78272, 39.04349], [-86.77194, 39.04796], [-86.7599, 39.04477], [-86.74279, 39.04724], [-86.75027, 39.07037], [-86.75812, 39.07398], [-86.74768, 39.08566], [-86.73991, 39.08481], [-86.74357, 39.10812], [-86.71911, 39.12383], [-86.7135, 39.13443], [-86.70401, 39.13601], [-86.69511, 39.14627], [-86.69352, 39.15974], [-86.68128, 39.17062], [-86.65942, 39.16787], [-86.64945, 39.16353], [-86.62678, 39.16305], [-86.61927, 39.16495], [-86.58287, 39.16495], [-86.58302, 39.18915], [-86.57117, 39.19327], [-86.56325, 39.18724], [-86.52142, 39.1861], [-86.5115, 39.18303], [-86.49847, 39.16435], [-86.47375, 39.16419], [-86.45532, 39.16661], [-86.44073, 39.16325], [-86.43056, 39.165], [-86.41247, 39.16213], [-86.40669, 39.1532], [-86.35577, 39.15097], [-86.34494, 39.15203], [-86.33296, 39.16228], [-86.31431, 39.16117], [-86.30185, 39.1549], [-86.28448, 39.15954], [-86.26761, 39.18015], [-86.25869, 39.18479], [-86.24648, 39.20285], [-86.20812, 39.19638], [-86.19284, 39.1909], [-86.17551, 39.18944], [-86.15452, 39.19122], [-86.13522, 39.19834], [-86.11756, 39.20064], [-86.09583, 39.19552], [-86.06844, 39.20011], [-86.0361, 39.19867], [-86.02395, 39.20038], [-85.99278, 39.19667], [-85.98374, 39.19922], [-85.95174, 39.20037], [-85.92708, 39.19737], [-85.90605, 39.20179], [-85.90327, 39.20725], [-85.88124, 39.20873], [-85.87583, 39.21301], [-85.87584, 39.22334], [-85.77312, 39.225], [-85.7639, 39.23087], [-85.73848, 39.23553], [-85.714, 39.24718], [-85.71358, 39.25116], [-85.69887, 39.26758], [-85.67433, 39.27184], [-85.64047, 39.2857], [-85.62109, 39.29062], [-85.60285, 39.30567], [-85.59233, 39.30583], [-85.55906, 39.31183], [-85.52291, 39.33233], [-85.51017, 39.33615], [-85.46657, 39.33638], [-85.46072, 39.33374], [-85.4143, 39.32326], [-85.40221, 39.32262], [-85.39112, 39.31817], [-85.37234, 39.31708], [-85.34376, 39.3115], [-85.29289, 39.30847], [-85.2387, 39.30841], [-85.2302, 39.30999], [-85.21784, 39.30624], [-85.20819, 39.31471], [-85.20842, 39.33312], [-85.20573, 39.33912], [-85.17602, 39.3362], [-85.15232, 39.34372], [-85.13758, 39.33947], [-85.11451, 39.3396], [-85.10932, 39.34548], [-85.11065, 39.35547], [-85.10401, 39.36017], [-85.10007, 39.3717], [-85.08555, 39.37766], [-85.0856, 39.393], [-85.07553, 39.39515], [-85.06841, 39.40382], [-85.05877, 39.40515], [-85.04853, 39.41374], [-85.03698, 39.417], [-85.03514, 39.42423], [-85.00914, 39.42072], [-85.00434, 39.43295], [-84.96375, 39.44329], [-84.92763, 39.44774], [-84.92009, 39.45438], [-84.89125, 39.45759], [-84.87243, 39.46914], [-84.84374, 39.47294], [-84.83381, 39.48129], [-84.8254, 39.48147], [-84.82167, 39.49399], [-84.75922, 39.50057], [-84.74921, 39.50742], [-84.6434, 39.50798], [-84.6289, 39.51114], [-84.6092, 39.51091], [-84.58774, 39.50155], [-84.57991, 39.50124], [-84.56843, 39.49398], [-84.54574, 39.49425], [-84.51782, 39.48802], [-84.49924, 39.4803], [-84.44451, 39.48125], [-84.43494, 39.48274], [-84.41362, 39.48106], [-84.3963, 39.47606], [-84.34295, 39.4739], [-84.34049, 39.48123], [-84.27481, 39.47732], [-84.2751, 39.46413], [-84.26421, 39.46196], [-84.25632, 39.45527], [-84.23876, 39.45159], [-84.22508, 39.44544], [-84.21529, 39.43377], [-84.19081, 39.4321], [-84.18029, 39.40622], [-84.16764, 39.38844], [-84.17292, 39.37334], [-84.17245, 39.36454], [-84.15598, 39.36715], [-84.12885, 39.35747], [-84.13143, 39.34673], [-84.12683, 39.3301], [-84.09818, 39.32066], [-84.08637, 39.3061], [-84.07095, 39.32153], [-84.0606, 39.31906], [-84.03763, 39.30823], [-84.02397, 39.30904], [-84.00512, 39.28903], [-83.98194, 39.29511], [-83.84102, 39.32536], [-83.78169, 39.32175], [-83.74262, 39.32209], [-83.69162, 39.32405], [-83.67166, 39.32875], [-83.61871, 39.33812], [-83.61433, 39.34105], [-83.58673, 39.34717], [-83.55457, 39.34546], [-83.54411, 39.35458], [-83.49432, 39.35938], [-83.45634, 39.35384], [-83.44425, 39.35455], [-83.41779, 39.3457], [-83.37578, 39.35289], [-83.28258, 39.35403], [-83.27376, 39.35623], [-83.24098, 39.35394], [-83.21682, 39.34895], [-83.17906, 39.34667], [-83.16483, 39.35359], [-83.15434, 39.35247], [-83.10709, 39.35336], [-83.09845, 39.35062], [-83.06345, 39.34823], [-83.05524, 39.35057], [-83.04217, 39.34804], [-83.02316, 39.33311], [-82.99308, 39.33457], [-82.98796, 39.3322], [-82.94286, 39.3383], [-82.9218, 39.32613], [-82.91126, 39.3171], [-82.89454, 39.31841], [-82.89506, 39.31219], [-82.88277, 39.30284], [-82.8751, 39.29016], [-82.85995, 39.28394], [-82.84112, 39.2815], [-82.81317, 39.27061], [-82.78521, 39.26441], [-82.77209, 39.25634], [-82.7606, 39.25436], [-82.75298, 39.24839], [-82.7362, 39.24265], [-82.71754, 39.24463], [-82.69225, 39.25423], [-82.68235, 39.26067], [-82.67924, 39.26769], [-82.65627, 39.2725], [-82.63705, 39.27064], [-82.61973, 39.27483], [-82.59333, 39.27117], [-82.58398, 39.26764], [-82.56234, 39.27139], [-82.5388, 39.27996], [-82.51925, 39.2716], [-82.48561, 39.24704], [-82.4556, 39.24382], [-82.44834, 39.2363], [-82.41899, 39.23549], [-82.39522, 39.23928], [-82.37414, 39.23677], [-82.36749, 39.24054], [-82.35327, 39.24059], [-82.34115, 39.23652], [-82.31141, 39.2357], [-82.27969, 39.22945], [-82.26643, 39.21613], [-82.23418, 39.21119], [-82.20238, 39.22334], [-82.19421, 39.23582], [-82.16525, 39.26106], [-82.15639, 39.27765], [-82.14872, 39.28435], [-82.12332, 39.29061], [-82.10302, 39.30412], [-82.104, 39.32452], [-82.09356, 39.33734], [-82.07719, 39.33751], [-82.04728, 39.33428], [-82.01097, 39.33393], [-82.00553, 39.33165], [-81.98114, 39.31259], [-81.963, 39.30479], [-81.94473, 39.30806], [-81.92744, 39.29205], [-81.92938, 39.27413], [-81.91835, 39.26832], [-81.90691, 39.25432], [-81.8949, 39.24804], [-81.88123, 39.23135], [-81.86143, 39.21686], [-81.84706, 39.21356], [-81.81404, 39.21214], [-81.80436, 39.22117], [-81.78431, 39.23452], [-81.77733, 39.23631], [-81.74649, 39.23682], [-81.72836, 39.24135], [-81.71316, 39.25025], [-81.68586, 39.27904], [-81.66491, 39.28556], [-81.64721, 39.28254], [-81.64655, 39.26267], [-81.64004, 39.25687], [-81.62549, 39.2565], [-81.60159, 39.2516], [-81.58276, 39.25641], [-81.57354, 39.26301], [-81.5403, 39.25382], [-81.52735, 39.26099], [-81.51152, 39.26602], [-81.49796, 39.26744], [-81.48595, 39.26349], [-81.48271, 39.25126], [-81.46981, 39.24199], [-81.45534, 39.23831], [-81.41358, 39.24232], [-81.40358, 39.2408], [-81.38637, 39.24675], [-81.36359, 39.24518], [-81.34566, 39.25282], [-81.30879, 39.24954], [-81.28976, 39.25895], [-81.27668, 39.25778], [-81.2623, 39.25078], [-81.25109, 39.25263], [-81.23367, 39.24652], [-81.22226, 39.23866], [-81.21099, 39.24029], [-81.20124, 39.25171], [-81.19054, 39.25583], [-81.18092, 39.25383], [-81.15962, 39.26067], [-81.12218, 39.26118], [-81.11252, 39.25679], [-81.10083, 39.26088], [-81.07077, 39.25995], [-81.05889, 39.26192], [-81.03997, 39.27139], [-81.01956, 39.27395], [-80.96938, 39.27454], [-80.9288, 39.26487], [-80.91434, 39.26922], [-80.89963, 39.26864], [-80.88351, 39.27459], [-80.85976, 39.27343], [-80.84556, 39.27802], [-80.80063, 39.2763], [-80.78026, 39.27907], [-80.7724, 39.28314], [-80.76082, 39.29602], [-80.75145, 39.29824], [-80.73347, 39.28651], [-80.71819, 39.28718], [-80.70005, 39.28483], [-80.6888, 39.27887], [-80.66947, 39.28313], [-80.64744, 39.28531], [-80.63364, 39.29255], [-80.61792, 39.29751], [-80.60696, 39.29484], [-80.58083, 39.29902], [-80.56729, 39.29385], [-80.55032, 39.29092], [-80.53015, 39.29052], [-80.52277, 39.28783], [-80.50559, 39.29274], [-80.48626, 39.28814], [-80.48253, 39.28344], [-80.46457, 39.27823], [-80.43167, 39.28641], [-80.41178, 39.2839], [-80.40285, 39.27714], [-80.38196, 39.26881], [-80.33704, 39.26393], [-80.32886, 39.2673], [-80.32116, 39.27886], [-80.28911, 39.27761], [-80.2795, 39.28066], [-80.2587, 39.28109], [-80.24228, 39.28919], [-80.23518, 39.28542], [-80.22275, 39.29271], [-80.20363, 39.29815], [-80.1813, 39.30177], [-80.17521, 39.29991], [-80.15865, 39.3034], [-80.14394, 39.31266], [-80.13454, 39.31379], [-80.11754, 39.32167], [-80.10887, 39.32964], [-80.10018, 39.32758], [-80.06212, 39.3373], [-80.04863, 39.35226], [-80.02294, 39.3442], [-80.01082, 39.34897], [-79.99069, 39.34128], [-79.96132, 39.34178], [-79.93935, 39.34484], [-79.93208, 39.33287], [-79.92524, 39.32939], [-79.90331, 39.33049], [-79.8565, 39.33854], [-79.84309, 39.3287], [-79.82097, 39.33016], [-79.80224, 39.32459], [-79.79015, 39.33324], [-79.7828, 39.33167], [-79.76743, 39.33505], [-79.75922, 39.32761], [-79.7453, 39.33109], [-79.72738, 39.33079], [-79.72104, 39.32309], [-79.69313, 39.31782], [-79.68126, 39.31961], [-79.66793, 39.32613], [-79.6381, 39.30806], [-79.63895, 39.29703], [-79.63313, 39.29155], [-79.61423, 39.29994], [-79.59887, 39.3016], [-79.59169, 39.31049], [-79.56685, 39.31801], [-79.55123, 39.32501], [-79.51946, 39.32645], [-79.48642, 39.31804], [-79.48144, 39.31246], [-79.4674, 39.30828], [-79.45095, 39.31216], [-79.4577, 39.33027], [-79.45077, 39.33829], [-79.44019, 39.34379], [-79.42038, 39.36248], [-79.41333, 39.37705], [-79.3974, 39.3973], [-79.40721, 39.407], [-79.39913, 39.42034], [-79.38164, 39.43649], [-79.36831, 39.46329], [-79.35516, 39.47646], [-79.34098, 39.49442], [-79.32767, 39.5012], [-79.32272, 39.51103], [-79.33115, 39.52137], [-79.34376, 39.52693], [-79.34434, 39.53583], [-79.35091, 39.54543], [-79.35293, 39.55886], [-79.36525, 39.56529], [-79.37058, 39.57212], [-79.35309, 39.5922], [-79.34069, 39.59474], [-79.33254, 39.61124], [-79.30998, 39.64293], [-79.30246, 39.64764], [-79.29493, 39.66577], [-79.28538, 39.67987], [-79.26775, 39.67799], [-79.25588, 39.68248], [-79.24789, 39.69433], [-79.2288, 39.69532], [-79.21607, 39.70596], [-79.18205, 39.70166], [-79.17255, 39.69556], [-79.16283, 39.69812], [-79.10049, 39.69455], [-79.0909, 39.68839], [-79.06388, 39.68339], [-79.0497, 39.68315], [-79.03188, 39.68726], [-78.97553, 39.68843], [-78.96271, 39.67937], [-78.96237, 39.67478], [-78.94347, 39.67548], [-78.92765, 39.65691], [-78.91391, 39.65135], [-78.90074, 39.65406], [-78.89032, 39.64421], [-78.8726, 39.64299], [-78.83962, 39.63642], [-78.82533, 39.64147], [-78.80186, 39.66533], [-78.79069, 39.67012], [-78.78139, 39.66333], [-78.76075, 39.65506], [-78.74593, 39.67307], [-78.73655, 39.67837], [-78.72329, 39.67249], [-78.71218, 39.67353], [-78.70473, 39.67867], [-78.68941, 39.67438], [-78.66883, 39.68226], [-78.65281, 39.6926], [-78.64055, 39.69543], [-78.62393, 39.70603], [-78.60793, 39.71274], [-78.59652, 39.70704], [-78.57494, 39.70556], [-78.55942, 39.69769], [-78.54379, 39.69432], [-78.51657, 39.69588], [-78.49287, 39.68152], [-78.47386, 39.67735], [-78.45828, 39.67714], [-78.45618, 39.6825], [-78.44383, 39.68342], [-78.42714, 39.69118], [-78.41412, 39.68893], [-78.38894, 39.7072], [-78.36473, 39.70692], [-78.35042, 39.70137], [-78.33157, 39.70618], [-78.31773, 39.70023], [-78.2977, 39.70016], [-78.28069, 39.70727], [-78.26871, 39.70651], [-78.25236, 39.69657], [-78.23209, 39.70386], [-78.22068, 39.69993], [-78.19917, 39.6973], [-78.18096, 39.70361], [-78.17057, 39.72361], [-78.14682, 39.73063], [-78.13591, 39.72579], [-78.12022, 39.72691], [-78.10174, 39.71048], [-78.08762, 39.71213], [-78.08174, 39.70619], [-78.07018, 39.70693], [-78.05436, 39.72706], [-78.03239, 39.7451], [-78.02319, 39.75578], [-77.99615, 39.80209], [-77.98261, 39.81235], [-77.97843, 39.82654], [-77.96735, 39.84124], [-77.96795, 39.85845], [-77.9655, 39.86716], [-77.94248, 39.86569], [-77.90412, 39.83404], [-77.9037, 39.82573], [-77.8738, 39.8056], [-77.84692, 39.80184], [-77.8077, 39.8053], [-77.77457, 39.79917], [-77.75458, 39.79164], [-77.73483, 39.79197], [-77.68566, 39.78156], [-77.64526, 39.77071], [-77.63166, 39.77041], [-77.581, 39.75751], [-77.55817, 39.74545], [-77.51984, 39.73447], [-77.50884, 39.73695], [-77.49872, 39.73414], [-77.4811, 39.73847], [-77.46973, 39.72746], [-77.45142, 39.73865], [-77.43586, 39.73883], [-77.41518, 39.74303], [-77.39151, 39.76076], [-77.37777, 39.78135], [-77.35739, 39.79548], [-77.34326, 39.78552], [-77.33381, 39.78339], [-77.31375, 39.76899], [-77.28288, 39.79709], [-77.27016, 39.8015], [-77.25161, 39.80222], [-77.21467, 39.78512], [-77.20504, 39.78235], [-77.19525, 39.78513], [-77.19176, 39.79188], [-77.1335, 39.7617], [-77.09766, 39.75363], [-77.08808, 39.74474], [-77.06566, 39.7537], [-77.05233, 39.75319], [-77.03429, 39.75776], [-77.02452, 39.76778], [-77.01185, 39.77475], [-76.99899, 39.78872], [-76.99104, 39.79366], [-76.98396, 39.7872], [-76.97511, 39.79291], [-76.96036, 39.77495], [-76.95962, 39.76223], [-76.94242, 39.74122], [-76.92436, 39.73255], [-76.91553, 39.71862], [-76.9176, 39.71136], [-76.89184, 39.68305], [-76.89177, 39.67289], [-76.88664, 39.66427], [-76.91034, 39.65029], [-76.93227, 39.63024], [-76.93488, 39.62222], [-76.94779, 39.60043], [-76.96636, 39.59234], [-76.99658, 39.57503], [-77.00686, 39.55922], [-77.01551, 39.55302], [-77.02127, 39.53416], [-77.03548, 39.52077], [-77.03881, 39.51431], [-77.05422, 39.50056], [-77.05832, 39.48745], [-77.07051, 39.47783], [-77.07671, 39.46691], [-77.08859, 39.45596], [-77.09533, 39.44423], [-77.10529, 39.43596], [-77.10979, 39.42304], [-77.12624, 39.41212], [-77.14097, 39.39246], [-77.14613, 39.37111], [-77.16147, 39.36332], [-77.15833, 39.34632], [-77.15305, 39.33944], [-77.15734, 39.32962], [-77.15766, 39.3174], [-77.16877, 39.30523], [-77.16111, 39.2899], [-77.16196, 39.28286], [-77.14763, 39.25824], [-77.13934, 39.2524], [-77.11751, 39.24608], [-77.09038, 39.22954], [-77.06772, 39.22609], [-77.03933, 39.20982], [-77.02428, 39.19897], [-77.02646, 39.19282], [-77.01167, 39.19055], [-77.00236, 39.19622], [-76.98005, 39.20005], [-76.97197, 39.18779], [-76.9604, 39.18156], [-76.94748, 39.16867], [-76.93694, 39.16368], [-76.92297, 39.15109], [-76.90427, 39.1454], [-76.88968, 39.14479], [-76.86972, 39.13681], [-76.85214, 39.11832], [-76.85615, 39.10146], [-76.84249, 39.09518], [-76.81734, 39.10033], [-76.77774, 39.09144], [-76.76492, 39.0931], [-76.75861, 39.08964], [-76.72714, 39.08714], [-76.71491, 39.09136], [-76.70145, 39.0886], [-76.66483, 39.0647], [-76.65961, 39.05777], [-76.63367, 39.05439], [-76.62794, 39.05945], [-76.61007, 39.04647], [-76.60412, 39.03904], [-76.60392, 39.02941], [-76.55987, 39.00666], [-76.54973, 38.99124], [-76.52694, 38.99644], [-76.51413, 38.9943], [-76.48587, 38.97727]

    ]]
  }
}


export interface IRaceTrackerMapProps {
  davesLat: number;
  davesLon: number;
}

export class RaceTrackerMap extends React.Component<IRaceTrackerMapProps, any> {

  private __unsubscribe = new Subject();


  constructor(props: any) {
    super(props);

    this.state = {
      mapStyle: defaultMapStyle,
      viewport: {
        width: "100%",
        height: 750,
        longitude: -79.467727,
        latitude: 8.331083,
        zoom: 2,
        bearing: 0,
        pitch: 0
      },

      riderData: [],
      calcData: {},
      popup: null
    };
  }



  private _autoClickForInitialFitToBounds = () => {

    var line = turf.lineString([[-117.388839, 33.191634], [-76.321246, 38.934216]]);
    const [minLng, minLat, maxLng, maxLat] = bbox(line);

    // construct a viewport instance from the current state
    const viewport = new WebMercatorViewport(this.state.viewport);
    const {longitude, latitude, zoom} = viewport.fitBounds([[minLng, minLat], [maxLng, maxLat]], {
      padding: 40
    });

    this.setState({
      viewport: {
        ...this.state.viewport,
        longitude,
        latitude,
        zoom,
        transitionInterpolator: new FlyToInterpolator(),
        transitionDuration: 1000
      }
    });

  };



  // I am calling this function which kind of returns the leaderboard (first to last, I think)
  // in each onclick function. From there I find the array index using Daves 
  // racer ID and then find the co ordinates of index +- 1. 

  // First finding the distance of each racer from that current coordinate to End point (finishline coordinate) to see who is closest to end line.
  // Then making a leader board sorted with distance (smallest distance first)  to finding ranking.
  // We will know Dave racer id. With that we will find the array index Dave is at. To find who is infront or behind him can be found by +-1 with index.    



  private _rankRiders = (route: any, positions: any) => {

    //Calculates rider position order given a route 
    // Accepts a linestring or multilinestring feature
    // and a geojson feature collection of point rider positions to rank
    // Returns a geojson format object with features in order of ranking, including
    // Metadata about the distance in miles along the route


    let rankedPositions = {
      "type": "FeatureCollection",
      "features": [] as any
    };

    let sortable: any = [];


    positions.forEach((rider: any) => {
      let riderId = rider["trackleaders_racer_ID"][0];

      if (!riderId) {
        return;
      }

      var aa = {
        lng: rider["message"][0]["longitude"][0],
        lat: rider["message"][0]["latitude"][0]
      }

      var pt = turf.point([parseFloat(aa.lng), parseFloat(aa.lat)]);
      var position = turf.nearestPointOnLine(route, pt);

      sortable.push([riderId, position.properties.location]);
      position.properties.riderId = riderId;

      rankedPositions.features.push(position);
    });

    sortable.sort(function(a: any, b: any) {
      return a[1] - b[1];
    });

    _.forEach(rankedPositions.features, feature => {
      let rankInField = sortable.length;  // default to last place
      _.forEach(sortable, rank => {
        if (rank[0] === feature.properties.riderId) {
          feature.properties.rank = rankInField
        }
        rankInField -= 1; //increase place by 1
      });
    });

    // sort rider id by distance along route
    // We will use distance (location) to order the rider id
    sortable.sort((a: any, b: any) => b[1] > a[1]);

    return {
      rank: sortable,
      positions: rankedPositions
    };
  }


  private _toggleRidersDaveMinusOne = () => {

    var data = this.state.calcData;

    var returnValue = this._rankRiders(route, data);

    // Daves Racer id is 60 for experimental Purpose
    var cnt = 0;
    var index = 0;

    _.forEach(returnValue.rank, rank => {

      if (rank[0] === "52") {
        index = cnt;
      }

      cnt++;

    });

    var daveCoordinate: any = returnValue.positions.features[index].geometry.coordinates;

    var daveLng = daveCoordinate[0];
    var daveLat = daveCoordinate[1];

    var targetCoordinate = returnValue.positions.features[index + 1].geometry.coordinates;

    var targetLng = targetCoordinate[0];
    var targetLat = targetCoordinate[1];

    var line = turf.lineString([[daveLng, daveLat], [targetLng, targetLat]]);

    // calculate the bounding box of the feature
    const [minLng, minLat, maxLng, maxLat] = bbox(line);

    // // // construct a viewport instance from the current state
    const viewport = new WebMercatorViewport(this.state.viewport);
    const {longitude, latitude} = viewport.fitBounds([[minLng, minLat], [maxLng, maxLat]], {
      padding: 200
    });

    this.setState({
      viewport: {
        ...this.state.viewport,
        longitude,
        latitude,
        zoom: 7,
        transitionInterpolator: new FlyToInterpolator(),
        transitionDuration: 1000
      }
    });

  };

  private _toggleRidersDavePlusOne = () => {

    var data = this.state.calcData;

    var returnValue = this._rankRiders(route, data);

    // Daves Racer id is 60 for experimental Purpose
    var cnt = 0;
    var index = 0;

    _.forEach(returnValue.rank, rank => {

      if (rank[0] === "52") {
        index = cnt;
      }

      cnt++;

    });

    var daveCoordinate: any = returnValue.positions.features[index].geometry.coordinates;
    var daveLng = daveCoordinate[0];
    var daveLat = daveCoordinate[1];

    var targetCoordinate = returnValue.positions.features[index - 1].geometry.coordinates;
    var targetLng = targetCoordinate[0];
    var targetLat = targetCoordinate[1];

    var line = turf.lineString([[daveLng, daveLat], [targetLng, targetLat]]);

    // calculate the bounding box of the feature
    const [minLng, minLat, maxLng, maxLat] = bbox(line);

    // // // construct a viewport instance from the current state
    const viewport = new WebMercatorViewport(this.state.viewport);
    const {longitude, latitude} = viewport.fitBounds([[minLng, minLat], [maxLng, maxLat]], {
      padding: 200
    });

    this.setState({
      viewport: {
        ...this.state.viewport,
        longitude,
        latitude,
        zoom: 7,
        transitionInterpolator: new FlyToInterpolator(),
        transitionDuration: 1000
      }
    });
  };


  public componentDidMount = () => {

    trackLeaderService
      .asObservable()
      .pipe(takeUntil(this.__unsubscribe))
      .subscribe(data => {
        if (!data) {
          return;
        }

        const trackleaders = data["trackleaders_aggregate_feed"]["trackleaders_feed"];

        const geojsonWrapper = {
          type: "FeatureCollection",
          features: []
        } as any;

        _.forEach(trackleaders, trackLeader => {
          if (!trackLeader.message || _.isEmpty(trackLeader.message)) {
            return;
          }

          const pointData = {
            type: "Feature",
            geometry: {
              type: "Point",
              coordinates: [
                parseFloat(trackLeader.message[0].longitude[0]),
                parseFloat(trackLeader.message[0].latitude[0])
              ]
            },
            properties: {
              description: {
                RacerID: trackLeader['trackleaders_racer_ID'][0],
                DeviceBatteryState: trackLeader.message[0]['batteryState'][0],
                ts: (trackLeader.message[0]['timestamp'] === null ? trackLeader.message[0]['dateTime'] : trackLeader.message[0]['timestamp']),
                lat: trackLeader.message[0]['latitude'],
                lng: trackLeader.message[0]['longitude']
              },
              speed: 10
            }
          };

          geojsonWrapper.features.push(pointData);
        });

        //Passing trackleader data to the toggle function
        this.setState({calcData: trackleaders})

        let {mapStyle} = this.state;
        if (!mapStyle.hasIn(["sources", "point"])) {
          mapStyle = mapStyle
            .setIn(
              ["sources", "point"],
              fromJS({type: "geojson", data: geojsonWrapper})
            )
            .set("layers", mapStyle.get("layers").push(pointLayer));
        }

        // Update data source
        mapStyle = mapStyle.setIn(
          ["sources", "point", "data"],
          geojsonWrapper
        );

        this.setState({mapStyle});
      });
  };

  public componentWillUnmount = () => {
    this.__unsubscribe.next();
    this.__unsubscribe.complete();
  };

  public render = () => (
    <div className={styles.root}>
      <ReactMapGL
        className={styles.map}
        mapboxApiAccessToken={TOKEN}
        mapStyle={this.state.mapStyle}
        {...this.state.viewport}
        onViewportChange={this.__handleViewportChange}
        onLoad={this._autoClickForInitialFitToBounds}
        onClick={this.__handleClick}>

        {this.__renderPopup()}
        <NavigationControl
          className={styles.nav}
          onViewportChange={this.__handleViewportChange} />

        <button
          className={styles.recenterMap}
          onClick={this._autoClickForInitialFitToBounds}
        >
          <Img src={reCenter} />
        </button>

        <button
          className={styles.goToDaveMinusOne}
          onClick={this._toggleRidersDaveMinusOne}
        >
          <Img src={imgDaveMinusPin} />
        </button>

        <button
          className={styles.goToDave}
          onClick={this.__handleClickGoToCyclist}
        >
          <Img src={imgPersonPin} />
        </button>

        <button
          className={styles.goToDavePlusOne}
          onClick={this._toggleRidersDavePlusOne}
        >
          <Img src={imgDavePlusPin} />
        </button>

      </ReactMapGL>
    </div>
  );

  private __handleClick = (event: any) => {
    const feature = event.features && event.features[0];

    if (feature) {
      if (feature.layer.id === "point") {
        this.setState({
          popup: {
            lat: event.lngLat[1],
            lng: event.lngLat[0],
            description: feature.properties.description
          }
        })

      }
    }
  };

  private __renderPopup = () => {
    const {popup} = this.state;

    return (
      popup && (
        <Popup
          tipSize={5}
          anchor="top"
          longitude={popup.lng}
          latitude={popup.lat}
          closeOnClick={false}
          onClose={() => this.setState({popup: null})}
        >
          <div>
            <h3>
              Racer ID: {JSON.parse(popup.description).RacerID}
            </h3>
            <strong>
              Device Battery State: {JSON.parse(popup.description).DeviceBatteryState}
            </strong>
            <br></br>
            <strong>
              Time Stamp: {JSON.parse(popup.description).ts}
            </strong>
            <br></br>
            <strong>
              Latitude: {JSON.parse(popup.description).lat}
            </strong>
            <br></br>
            <strong>
              Longitude: {JSON.parse(popup.description).lng}
            </strong>
          </div>
        </Popup>
      )
    );
  }



  private __handleClickGoToCyclist = () => {
    const data = this.state.calcData;
    

    if (_.isEmpty(data) || !_.isArray(data.message) || _.isEmpty(data.message[0])) {
      return;
    }

    const viewport = {
      ...this.state.viewport,
      latitude: parseFloat(data[0].message[0].latitude[0]),
      longitude: parseFloat(data[0].message[0].longitude[0]),
      zoom: 14,
      transitionDuration: 5000,
      transitionInterpolator: new FlyToInterpolator()
    };
    
    this.setState({viewport});
  };

  private __handleViewportChange = (viewport: any) => {
    this.setState({viewport});
  };

}
